# Changelog

All notable changes to the `battenberg` module will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).


## [1.3] - 2025-12-10

This release introduces multi-ploidy fit orchestration and refactors the module into a two-stage workflow to make repeated constrained fits efficient and transparent.

Highlights
- Split the workflow into a preprocessing stage and a lightweight per-ploidy fit stage. Preprocessing produces preserved per-pair `.tab` tables (allele counts, BAF, logR, GC-corrected logR) under `preprocess/` so they can be re-used by multiple fit jobs.
- New configuration key `options.ploidy_runs` (list of `"MIN-MAX"` strings) drives how many fit jobs are created per pair. The first list entry is used as the canonical ploidy for downstream outputs.
- The R runner (`src/battenberg_wgs_hg38.R`) now accepts `--ploidy_constraint MIN-MAX` (parses into `min_ploidy`/`max_ploidy`) while keeping backward-compatible `--min_ploidy`/`--max_ploidy` flags.
- Per-fit outputs are written under `ploidy_<MIN-MAX>/` directories and the fit rule symlinks precomputed tables into the fit directory.
- `_battenberg_cleanup` now waits for all per-ploidy fit outputs before removing preserved `preprocess/*.tab` files to ensure fits can run in parallel safely.
- Documentation updated: `README.md` and `config/default.yaml` include `ploidy_runs` with examples and explanatory comments.

Compatibility
- Existing pipelines that rely on the previous single-fit behavior continue to work by leaving `options.ploidy_runs` as the default single entry (`"1.6-4.8"`). The runner still accepts `--min_ploidy`/`--max_ploidy`.

Rationale
- Running multiple constrained fits inside Snakemake (rather than looping inside the R script) preserves transparency, enables parallel execution, and makes it easy to choose a canonical fit for downstream outputs.


## [1.2] - 2021-04-23

This release was authored by Lakshay Sethi.
This overhaul began with addition of an automatic way to download reference files, as a way to handle the grievances
from version 1.0. To achieve this I created a new rule, _battenberg_get_reference, through which I downloaded the files from GSC web portal and used a script called reference_correction.py, to automatically replace placeholders with the correct paths. After this I automated the way chr prefix are used, using a regex statement to directly read it from the genome.fa file of that respective genome_build. To increase the scalability of Battenberg, ability to use different genomes where added by making a VERSION_MAP dictionary. Then to make the log files more informative, I shifted the output generated by  rule _install_battenberg from terminal to log file called input.log.
As a result of both reference file downloading and chr prefix reading going automatic, variables  reference_path  and  chr_prefixed_reference from config file were removed.

## [1.1] - 2020-12-22

This release was authored by Ryan Morin.
This overhaul began with addition of cram support. This required a new symlink to the bai file with a name that can be found by HTSlib (i.e. .crai). Unfortunately the automatic inference of patient sex was affected by this change because "samtools idxstats" is extremely slow on cram files. To help address the effect of this on performance this step has been placed in a separate rule and writes a small text file to record the inferred sex per patient. calc_sex_status.sh was extended to automatically infer the name of both sex chromosomes from the header, making it optional to specify this. This change also leads to a much simpler config. This version also includes job grouping to allow quick-running rules to be submitted as jobs along with long-running steps (avoiding too many local rules). The Battenberg script in this repo and the forked Battenberg R package were both modified to allow the reference genome fasta file to be specified (needed for CRAM support).

Some other minor changes occur in this version:
-The src directory has a simpler structure (no subdirectories) and this is exported as PATH in some rules to further simplify the config. 
-The newest post-processing script in LCR-scripts is used to properly infer the log-ratio using clonal and subclonal events (this was completely broken in previous versions)

## [1.0] - 2020-06-17

This release was authored by Ryan Morin.

I modified the Battenberg source code to take an optional "chr_prefixed_genome" argument and some modifications to enable battenberg to work with genomes that have "chr" prefixes in the chromosome names. The installation uses conda to create an R installation with all required prerequisites with the exception of ASCAT and Battenberg, which are installed from github. The modified R script that runs the pipeline is bundled with this tool but this may not be necessary for future releases. 

This installation is currently accomplished by a _install_battenberg rule but there is probably a better way (subworkflow?).  
Obtaining and setting up reference directories for Battenberg is CURRENTLY UP TO THE USER. The forked repository (https://github.com/morinlab/battenberg) describes how this can be achieved. I decided to forego auto-installation of references due to some finnicky steps required (e.g. creating a file that includes the full path to each reference file on the local filesystem). I am open to suggestions for how to elegantly handle this annoyance. 

In contrast to the Sequenza module, I haven't embedded cnv2igv.py in the module. Instead, the user must specify the path to their LCR-scripts repository. Similar to my original version of Sequenza, I relied on the calc_sex_status.sh script because it was working. Suggestions for more elegant solutions are welcome. 
